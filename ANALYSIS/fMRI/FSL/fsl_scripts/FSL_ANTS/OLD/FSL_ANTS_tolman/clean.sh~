#!/bin/bash

# pull in the subject we should be working on
subjectID=$1
runID=$2

echo "Preparing subject ${subjectID} session ${runID}"

# the subject directory
subT2=/home/evapool/PAVMOD/DATA/brain/ICA_ANTS/${subjectID}/T2_reoriented_brain.nii.gz
# standardT2=/home/jcockburn/casino_fMRI/fMRI_PreProcessing/ICA_ANTs/CIT168_T2w_MNI_lowres
# Directory containing functionals, high-res reference scans, and field-maps
funcDir=/home/evapool/PAVMOD/DATA/brain/ICA_ANTS/${subjectID}/RUN_${runID}.ica/
# Directory with run-specific files
runDir=/home/evapool/PAVMOD/DATA/brain/ICA_ANTS/${subjectID}/RUN_${runID}/
# the component classification rejection threshold
threshold=20
# the dwell time for fugue unwarping
dwellTime=0.00054

###################
# classify components as artifact/signal, remove artifacts
# generates filtered_func_data_clean in the ICA directory
echo "started classification at $(date +"%T")"
# the classifier path
classifierPath=/home/shared/fix/classifiers/FIX_giovanniCoins_jeffCasinoUSA.RData
# classify components (approx 30 min)
# will generate a label file at the specified threshold called fix4melview_FIX_giovanniCoins_jeffCasinoUSA_thr<threshold>.txt
/usr/local/fix/fix -c ${funcDir} ${classifierPath} ${threshold}
echo "Classification done at $(date +"%T")"
# remove bad ones
/usr/local/fix/fix -a ${funcDir}fix4melview_FIX_giovanniCoins_jeffCasinoUSA_thr${threshold}.txt -m
echo "finished cleanup at $(date +"%T")"

#######################
# apply fieldmap unwarping

# # unwarp the functionals
echo "Unwarping functionals for Subject ${subjectID} Session ${runID} at $(date +"%T")"
funcScan=${funcDir}filtered_func_data_clean
mapImage=${runDir}RUN_${runID}_rad
fugue -i ${funcScan} --dwell=${dwellTime} --loadfmap=${mapImage} --unwarpdir=y -u ${funcScan}_unwarped
# extract a single volumn for warped/unwarped comparison to the original T2
fslroi ${funcScan} ${funcScan}_sample 0 1
fslroi ${funcScan}_unwarped ${funcScan}_unwarped_sample 0 1
flirt -in ${funcScan}_sample -ref ${subT2} -dof 6 -out ${funcScan}_sample_alignT2 -omat ${funcScan}_sample_alignT2.mat
flirt -in ${funcScan}_unwarped_sample -ref ${subT2} -init ${funcScan}_sample_alignT2.mat -applyxfm -out ${funcScan}_unwarped_sample_alignT2
echo "done unwarping functional scan for Subject ${subjectID} Session ${runID} at $(date +"%T")"

# # unwarp the reference image
echo "Unwarping reference scan for Subject ${subjectID} Session ${runID} at $(date +"%T")"
refScan=${runDir}RUN_SB_${runID}_reoriented_brain_restore
mapImage=${runDir}RUN_${runID}_rad
fugue -i ${refScan} --dwell=${dwellTime} --loadfmap=${mapImage} --unwarpdir=y -u ${refScan}_unwarped
# save T2-aligned warped & unwarped images for comparison
flirt -in ${refScan} -ref ${subT2} -dof 6 -out ${refScan}_alignT2 -omat ${refScan}_alignT2.mat
flirt -in ${refScan}_unwarped -ref ${subT2} -init ${refScan}_alignT2.mat -applyxfm -out ${refScan}_unwarped_alignT2
echo "Done Unwarping reference for Subject ${subjectID} Session ${runID} at $(date +"%T")"
